generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum GlobalRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum SpaceRole {
  ADMIN
  MODERATOR
  MEMBER
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  DONE
}

enum BanType {
  SOFT
  HARD
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

// ─── USERS ───────────────────────────────────────────────

model User {
  id           String     @id @default(cuid())
  name         String
  email        String     @unique
  passwordHash String
  role         GlobalRole @default(MEMBER)
  banned       Boolean    @default(false)
  bannedReason String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  invitesCreated   Invite[]        @relation("InviteCreator")
  spaceMemberships SpaceMember[]
  messages         Message[]
  sentDMs          DirectMessage[] @relation("DMSender")
  dmThreadsAsUser1 DirectThread[]  @relation("DirectThreadUser1")
  dmThreadsAsUser2 DirectThread[]  @relation("DirectThreadUser2")
  files            File[]
  tasksCreated     Task[]          @relation("TaskCreator")
  tasksAssigned    Task[]          @relation("TaskAssignee")
  taskComments     TaskComment[]
  posts            Post[]
  postAnswers      PostAnswer[]
  reportsFiled     Report[]        @relation("Reporter")
  reportsResolved  Report[]        @relation("ReportResolver")
  bansReceived     Ban[]           @relation("BannedUser")
  bansIssued       Ban[]           @relation("BanIssuer")
  auditLogs        AuditLog[]

  @@index([email])
}

// ─── INVITES ─────────────────────────────────────────────

model Invite {
  id        String    @id @default(cuid())
  token     String    @unique @default(cuid())
  createdBy String
  creator   User      @relation("InviteCreator", fields: [createdBy], references: [id])
  maxUses   Int       @default(1)
  uses      Int       @default(0)
  singleUse Boolean   @default(true)
  expiresAt DateTime?
  revoked   Boolean   @default(false)
  createdAt DateTime  @default(now())

  @@index([token])
}

// ─── SPACES ──────────────────────────────────────────────

model Space {
  id          String   @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members  SpaceMember[]
  channels Channel[]
  files    File[]
  tasks    Task[]
  posts    Post[]
}

model SpaceMember {
  id       String    @id @default(cuid())
  userId   String
  spaceId  String
  role     SpaceRole @default(MEMBER)
  joinedAt DateTime  @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)

  @@unique([userId, spaceId])
  @@index([spaceId])
}

// ─── CHANNELS & MESSAGES ─────────────────────────────────

model Channel {
  id          String   @id @default(cuid())
  spaceId     String
  name        String
  description String?
  createdAt   DateTime @default(now())

  space        Space                @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  messages     Message[]
  readReceipts ChannelReadReceipt[]

  @@index([spaceId])
}

model DirectThread {
  id        String   @id @default(cuid())
  user1Id   String
  user2Id   String
  createdAt DateTime @default(now())

  user1    User            @relation("DirectThreadUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2    User            @relation("DirectThreadUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  messages DirectMessage[]

  lastReadUser1At DateTime @default(now())
  lastReadUser2At DateTime @default(now())

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
}

model DirectMessage {
  id        String   @id @default(cuid())
  threadId  String
  userId    String
  content   String
  createdAt DateTime @default(now())

  thread DirectThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User         @relation("DMSender", fields: [userId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
}

model ChannelReadReceipt {
  id         String   @id @default(cuid())
  channelId  String
  userId     String
  lastReadAt DateTime @default(now())

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)

  @@unique([userId, channelId])
  @@index([channelId])
}

model Message {
  id        String    @id @default(cuid())
  channelId String
  userId    String
  content   String
  deletedAt DateTime?
  createdAt DateTime  @default(now())

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([channelId, createdAt])
}

// ─── FILES ───────────────────────────────────────────────

model File {
  id         String   @id @default(cuid())
  spaceId    String
  userId     String
  name       String
  size       Int
  mimeType   String
  storageKey String
  url        String
  createdAt  DateTime @default(now())

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([spaceId])
}

// ─── TASKS (UPPDRAG) ────────────────────────────────────

model Task {
  id          String     @id @default(cuid())
  spaceId     String
  title       String
  description String?
  status      TaskStatus @default(OPEN)
  tags        String[]
  assigneeId  String?
  createdBy   String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  space    Space         @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  assignee User?         @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator  User          @relation("TaskCreator", fields: [createdBy], references: [id])
  comments TaskComment[]

  @@index([spaceId, status])
}

model TaskComment {
  id        String   @id @default(cuid())
  taskId    String
  userId    String
  content   String
  createdAt DateTime @default(now())

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── POSTS (FRÅGA & HJÄLP) ─────────────────────────────

model Post {
  id        String   @id @default(cuid())
  spaceId   String
  userId    String
  title     String
  content   String
  tags      String[]
  solved    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  space   Space        @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers PostAnswer[]

  @@index([spaceId])
}

model PostAnswer {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  content   String
  accepted  Boolean  @default(false)
  createdAt DateTime @default(now())

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ─── MODERATION ──────────────────────────────────────────

model Report {
  id         String       @id @default(cuid())
  reporterId String
  targetType String // "message", "post", "postAnswer", "task"
  targetId   String
  reason     String
  status     ReportStatus @default(PENDING)
  resolvedBy String?
  resolvedAt DateTime?
  createdAt  DateTime     @default(now())

  reporter User  @relation("Reporter", fields: [reporterId], references: [id])
  resolver User? @relation("ReportResolver", fields: [resolvedBy], references: [id])

  @@index([status])
}

model Ban {
  id        String   @id @default(cuid())
  userId    String
  reason    String
  bannedBy  String
  type      BanType  @default(SOFT)
  createdAt DateTime @default(now())

  user   User @relation("BannedUser", fields: [userId], references: [id])
  issuer User @relation("BanIssuer", fields: [bannedBy], references: [id])

  @@index([userId])
}

// ─── AUDIT LOG ───────────────────────────────────────────

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String // e.g. "invite.create", "user.ban", "message.delete"
  targetType String?
  targetId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([action])
}
